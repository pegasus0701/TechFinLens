<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice Upload & Analyze</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    /* Upload Card */
    .upload-card {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 25px;
    }
    
    .upload-card h2 {
      color: #004578;
      margin-bottom: 20px;
    }
    
    input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 2px dashed #0078d4;
      border-radius: 6px;
      margin-bottom: 18px;
      background: #f8f9fa;
      transition: border-color 0.3s ease;
    }
    
    input[type="file"]:hover {
      border-color: #005ea2;
    }
    
    button {
      background: #0078d4;
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 6px;
      font-size: 14px;
    }
    
    button:hover {
      background: #005ea2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Results Styling */
    .results-container {
      text-align: left;
      margin-top: 30px;
    }
    
    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      display: inline-block;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    /* Cards for Results */
    .card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card-header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 20px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .card-header h2 {
      font-size: 1.4rem;
      margin: 0;
      color: white;
    }
    
    .card-body {
      padding: 25px;
    }
    
    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
    }
    
    .summary-card h3 {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .summary-card .value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .summary-card .subtext {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    /* Tables */
    .info-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .info-table th {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 15px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .info-table td {
      padding: 15px 20px;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .info-table tr:last-child td {
      border-bottom: none;
    }
    
    .info-table tr:hover {
      background: #f8f9fa;
    }
    
    /* Line Items Table */
    .line-items-table {
      font-size: 0.9rem;
    }
    
    .line-items-table th {
      background: linear-gradient(135deg, #27ae60, #229954);
    }
    
    .amount-column {
      text-align: right;
      font-weight: 600;
    }
    
    .numeric-column {
      text-align: right;
    }
    
    /* Sections */
    .section {
      margin-bottom: 30px;
    }
    
    .section-title {
      font-size: 1.3rem;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
      display: flex;
      align-items: center;
    }
    
    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0078d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Color variations for cards */
    .card-vendor { border-left: 4px solid #e74c3c; }
    .card-amounts { border-left: 4px solid #f39c12; }
    .card-lines { border-left: 4px solid #27ae60; }
    .card-status { border-left: 4px solid #9b59b6; }
    .card-service { border-left: 4px solid #e67e22; }
    
    /* Progress Bar */
    .progress-container {
      width: 100%;
      background: #f0f0f0;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 8px;
      background: linear-gradient(90deg, #0078d4, #00a2ff);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
      
      .card-body {
        padding: 15px;
      }
      
      .info-table {
        font-size: 0.8rem;
      }
      
      .info-table th,
      .info-table td {
        padding: 10px 12px;
      }
      
      .upload-card {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      button {
        padding: 10px 16px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÑ Smart Invoice Processor</h1>
      <p>Upload, analyze, and store invoices with AI-powered accuracy</p>
    </div>

    <!-- Upload Section -->
    <div class="upload-card">
      <h2>Upload Invoice</h2>
      <form id="uploadForm" enctype="multipart/form-data" onsubmit="return false;">
        <input type="file" id="file" name="file" accept=".pdf,.jpg,.png,.jpeg" required>
        <br>
        <button type="button" id="uploadBtn">üì§ Upload to Blob Storage</button>
        <button type="button" id="analyzeBtn" disabled>üß† Analyze & Store Invoice</button>
        <button type="button" id="resetBtn" style="background: #6c757d;">üîÑ Reset</button>
      </form>
      
      <!-- Progress Bar -->
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      
      <!-- Simple status output -->
      <div id="simpleOutput" style="text-align: left; margin-top: 20px; background: #f9f9f9; padding: 12px; border-radius: 8px; font-size: 13px; border: 1px solid #eee;">
        <strong>Status:</strong> Ready to upload invoice...
      </div>
    </div>

    <!-- Beautiful Results Container -->
    <div class="results-container" id="resultsContainer">
      <!-- Results will be displayed here beautifully -->
    </div>
  </div>

  <script>
let uploadedBlobUrl = null;

// Upload to Blob
document.getElementById('uploadBtn').addEventListener('click', async () => {
  const file = document.getElementById('file').files[0];
  if(!file){ 
    showMessage('Please choose a file first!', 'error');
    return; 
  }

  const formData = new FormData();
  formData.append('file', file);

  const simpleOutput = document.getElementById('simpleOutput');
  const resultsContainer = document.getElementById('resultsContainer');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  
  // Reset and show progress
  resultsContainer.innerHTML = '';
  progressContainer.style.display = 'block';
  progressBar.style.width = '30%';
  simpleOutput.innerHTML = '<span class="loading"></span><strong>Status:</strong> üì§ Uploading to Azure Blob Storage...';

  try {
    const res = await fetch('/upload_blob', { method: 'POST', body: formData });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    
    if(data.blob_url){
      uploadedBlobUrl = data.blob_url;
      progressBar.style.width = '60%';
      simpleOutput.innerHTML = '‚úÖ <strong>Status:</strong> Uploaded to Blob Successfully!<br><small>URL: ' + data.blob_url + '</small>';
      document.getElementById('analyzeBtn').disabled = false;
    } else {
      progressBar.style.width = '0%';
      simpleOutput.innerHTML = '‚ùå <strong>Status:</strong> Upload failed: ' + (data.error || JSON.stringify(data));
    }
  } catch (err) {
    progressBar.style.width = '0%';
    simpleOutput.innerHTML = '‚ùå <strong>Status:</strong> Error: ' + err.message;
    console.error('Upload error:', err);
  }
});

// Analyze Invoice
document.getElementById('analyzeBtn').addEventListener('click', async () => {
  if(!uploadedBlobUrl){ 
    showMessage('Please upload a file first!', 'error');
    return; 
  }

  const simpleOutput = document.getElementById('simpleOutput');
  const resultsContainer = document.getElementById('resultsContainer');
  const progressBar = document.getElementById('progressBar');
  
  progressBar.style.width = '80%';
  simpleOutput.innerHTML = '<span class="loading"></span><strong>Status:</strong> üß† Analyzing invoice with AI...';
  resultsContainer.innerHTML = '';

  try {
    const res = await fetch('/analyze_invoice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ blob_sas_url: uploadedBlobUrl })
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    progressBar.style.width = '100%';
    simpleOutput.innerHTML = '‚úÖ <strong>Status:</strong> Analysis Completed Successfully!';
    
    // Display beautiful results
    displayBeautifulResults(data);
    
    // Hide progress bar after success
    setTimeout(() => {
      document.getElementById('progressContainer').style.display = 'none';
    }, 2000);
    
  } catch (err) {
    progressBar.style.width = '0%';
    simpleOutput.innerHTML = '‚ùå <strong>Status:</strong> Analysis Error: ' + err.message;
    resultsContainer.innerHTML = `
      <div class="status-badge status-error">‚ùå Analysis Failed</div>
      <div class="card">
        <div class="card-body">
          <p><strong>Error:</strong> ${err.message}</p>
          <p>Please check if the backend server is running and try again.</p>
        </div>
      </div>
    `;
    console.error('Analysis error:', err);
  }
});

// Reset functionality
document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('file').value = '';
  document.getElementById('simpleOutput').innerHTML = '<strong>Status:</strong> Ready to upload invoice...';
  document.getElementById('resultsContainer').innerHTML = '';
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('progressContainer').style.display = 'none';
  uploadedBlobUrl = null;
  showMessage('Form reset successfully!', 'success');
});

// Helper function to show messages
function showMessage(message, type = 'info') {
  const simpleOutput = document.getElementById('simpleOutput');
  const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
  simpleOutput.innerHTML = `${icon} <strong>Status:</strong> ${message}`;
}

// Safe value extraction helper functions
function safeString(value, defaultValue = 'Not Available') {
  return value && value !== 'null' && value !== 'undefined' ? String(value) : defaultValue;
}

function safeNumber(value, defaultValue = 0) {
  const num = parseFloat(value);
  return !isNaN(num) ? num : defaultValue;
}

function safeCurrency(value, currency = 'USD') {
  const num = safeNumber(value);
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: currency
  }).format(num);
}

// Function to display beautiful results
function displayBeautifulResults(result) {
  const container = document.getElementById('resultsContainer');
  
  console.log('Raw API response:', result);
  
  // Handle different response formats
  let extractedData = result;
  let saveResult = { success: false, stored_data: {} };
  let analysisStatus = "‚úÖ ANALYSIS COMPLETED";

  // If response has error status
  if (result.status === "ANALYSIS FAILED" || result.status === "EXTRACTION FAILED") {
    container.innerHTML = `
      <div class="status-badge status-error">‚ùå ${result.status}</div>
      <div class="card">
        <div class="card-body">
          <p><strong>Error:</strong> ${result.error || 'Unknown error occurred'}</p>
          <p>Please try uploading the file again or contact support.</p>
        </div>
      </div>
    `;
    return;
  }

  // If response has nested structure
  if (result.extracted_data) {
    extractedData = result.extracted_data;
    saveResult = result.save_result || { success: false, stored_data: {} };
  }
  
  // If response has the beautiful format from Python code
  if (result["üéØ ANALYSIS STATUS"]) {
    analysisStatus = result["üéØ ANALYSIS STATUS"];
    extractedData = extractDataFromBeautifulFormat(result);
    saveResult = result["üíæ DATABASE STORAGE STATUS"] || { success: false, stored_data: {} };
  }

  // Extract data with safe defaults using helper functions
  const vendorName = safeString(extractedData.vendor_name || extractedData.vendorName);
  const invoiceNo = safeString(extractedData.invoice_no || extractedData.invoiceNo || extractedData.invoice_number);
  const invoiceDate = safeString(extractedData.invoice_date || extractedData.invoiceDate);
  const currency = safeString(extractedData.currency, 'USD');
  const subtotal = safeNumber(extractedData.subtotal);
  const totalTax = safeNumber(extractedData.total_tax || extractedData.tax);
  const totalAmount = safeNumber(extractedData.total_amount || extractedData.total);
  const lineItems = Array.isArray(extractedData.line_items) ? extractedData.line_items : 
                   Array.isArray(extractedData.items) ? extractedData.items : [];
  const ocrConfidence = safeNumber(extractedData.ocr_confidence, 0.85);
  const customerName = safeString(extractedData.customer_name || extractedData.customerName);
  const vendorAddress = safeString(extractedData.vendor_address);
  const customerAddress = safeString(extractedData.customer_address);
  const jobNumber = safeString(extractedData.job_number || extractedData.jobNumber);
  const technicians = safeString(extractedData.technicians || extractedData.service_technicians);
  const serviceIssue = safeString(extractedData.service_issue || extractedData.issue);
  const servicePerformed = safeString(extractedData.service_performed || extractedData.repairs);
  const hvacBrand = safeString(extractedData.hvac_brand || extractedData.brand);

  const confidencePercent = (ocrConfidence * 100).toFixed(1);

  container.innerHTML = `
    <!-- Status Card -->
    <div class="card card-status">
      <div class="card-header">
        <h2>üéØ Analysis Status</h2>
        <div class="status-badge status-success">${analysisStatus}</div>
      </div>
      <div class="card-body">
        <div class="summary-grid">
          <div class="summary-card">
            <h3>Total Amount</h3>
            <div class="value">${safeCurrency(totalAmount, currency)}</div>
            <div class="subtext">Invoice Total</div>
          </div>
          <div class="summary-card">
            <h3>OCR Confidence</h3>
            <div class="value">${confidencePercent}%</div>
            <div class="subtext">AI Accuracy Score</div>
          </div>
          <div class="summary-card">
            <h3>Line Items</h3>
            <div class="value">${lineItems.length}</div>
            <div class="subtext">Items Processed</div>
          </div>
          <div class="summary-card">
            <h3>Database Status</h3>
            <div class="value">${saveResult.success ? '‚úÖ' : '‚ùå'}</div>
            <div class="subtext">${saveResult.success ? 'Stored' : 'Failed'}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vendor & Invoice Information -->
    <div class="card card-vendor">
      <div class="card-header">
        <h2>üè¢ Vendor & Invoice Information</h2>
      </div>
      <div class="card-body">
        <div class="section">
          <div class="section-title">Vendor Details</div>
          <table class="info-table">
            <tr>
              <th>Field</th>
              <th>Value</th>
            </tr>
            <tr>
              <td><strong>Vendor Name</strong></td>
              <td>${vendorName}</td>
            </tr>
            <tr>
              <td><strong>Vendor Address</strong></td>
              <td>${vendorAddress}</td>
            </tr>
            <tr>
              <td><strong>Invoice Number</strong></td>
              <td>${invoiceNo}</td>
            </tr>
            <tr>
              <td><strong>Service Date</strong></td>
              <td>${invoiceDate}</td>
            </tr>
            <tr>
              <td><strong>Job Number</strong></td>
              <td>${jobNumber}</td>
            </tr>
            <tr>
              <td><strong>Currency</strong></td>
              <td>${currency}</td>
            </tr>
          </table>
        </div>

        <div class="section">
          <div class="section-title">Customer Information</div>
          <table class="info-table">
            <tr>
              <th>Field</th>
              <th>Value</th>
            </tr>
            <tr>
              <td><strong>Customer Name</strong></td>
              <td>${customerName}</td>
            </tr>
            <tr>
              <td><strong>Customer Address</strong></td>
              <td>${customerAddress}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Service Details -->
    <div class="card card-service">
      <div class="card-header">
        <h2>üîß Service Details</h2>
      </div>
      <div class="card-body">
        <table class="info-table">
          <tr>
            <th>Field</th>
            <th>Value</th>
          </tr>
          <tr>
            <td><strong>Technicians</strong></td>
            <td>${technicians}</td>
          </tr>
          <tr>
            <td><strong>Service Issue</strong></td>
            <td>${serviceIssue}</td>
          </tr>
          <tr>
            <td><strong>Service Performed</strong></td>
            <td>${servicePerformed}</td>
          </tr>
          <tr>
            <td><strong>HVAC Brand</strong></td>
            <td>${hvacBrand}</td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Amount Breakdown -->
    <div class="card card-amounts">
      <div class="card-header">
        <h2>üí∞ Amount Breakdown</h2>
      </div>
      <div class="card-body">
        <table class="info-table">
          <tr>
            <th>Description</th>
            <th style="text-align: right;">Amount</th>
          </tr>
          <tr>
            <td>Subtotal</td>
            <td class="amount-column">${safeCurrency(subtotal, currency)}</td>
          </tr>
          <tr>
            <td>Tax</td>
            <td class="amount-column">${safeCurrency(totalTax, currency)}</td>
          </tr>
          <tr style="background: linear-gradient(135deg, #ffeaa7, #fab1a0); font-weight: bold;">
            <td>Total Amount</td>
            <td class="amount-column" style="font-size: 1.1em;">${safeCurrency(totalAmount, currency)}</td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Line Items -->
    <div class="card card-lines">
      <div class="card-header">
        <h2>üìã Line Items (${lineItems.length})</h2>
      </div>
      <div class="card-body">
        ${lineItems.length > 0 ? `
        <table class="info-table line-items-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Description</th>
              <th style="text-align: right;">Qty</th>
              <th style="text-align: right;">Unit Price</th>
              <th style="text-align: right;">Amount</th>
              ${lineItems[0].product_code ? '<th>Type</th>' : ''}
            </tr>
          </thead>
          <tbody>
            ${lineItems.map(item => {
              const lineNo = safeNumber(item.line_no || item.Line);
              const description = safeString(item.description || item.Description, 'No description');
              const quantity = safeNumber(item.quantity || item.Quantity);
              const unitPrice = safeNumber(item.unit_price || parseFloat(String(item['Unit Price'] || '').replace(/[^\d.-]/g, '')));
              const amount = safeNumber(item.amount || parseFloat(String(item.Amount || '').replace(/[^\d.-]/g, '')));
              const productCode = safeString(item.product_code || item.Type);
              
              return `
              <tr>
                <td>${lineNo}</td>
                <td>${description}</td>
                <td class="numeric-column">${quantity}</td>
                <td class="amount-column">${safeCurrency(unitPrice, currency)}</td>
                <td class="amount-column">${safeCurrency(amount, currency)}</td>
                ${productCode !== 'Not Available' ? `<td><span style="padding: 4px 8px; background: #e8f4fd; border-radius: 4px; font-size: 0.8em;">${productCode}</span></td>` : ''}
              </tr>
            `}).join('')}
          </tbody>
        </table>
        ` : '<p>No line items found in the invoice</p>'}
      </div>
    </div>

    <!-- Storage Status -->
    <div class="card">
      <div class="card-header">
        <h2>üíæ Database Storage Status</h2>
      </div>
      <div class="card-body">
        <table class="info-table">
          <tr>
            <th>Component</th>
            <th>Status</th>
            <th>Details</th>
          </tr>
          <tr>
            <td>Invoice Header</td>
            <td>${saveResult["Invoice Stored"] === "Yes" || (saveResult.stored_data && saveResult.stored_data.invoices_stored) ? '‚úÖ Stored' : '‚ùå Failed'}</td>
            <td>Main invoice data</td>
          </tr>
          <tr>
            <td>Vendor Information</td>
            <td>${saveResult["Vendor Stored"] === "Yes" || (saveResult.stored_data && saveResult.stored_data.vendors_stored && saveResult.stored_data.vendors_stored.length > 0) ? '‚úÖ Stored' : '‚ùå Failed'}</td>
            <td>Vendor details</td>
          </tr>
          <tr>
            <td>Customer Information</td>
            <td>${saveResult["Customer Stored"] === "Yes" || (saveResult.stored_data && saveResult.stored_data.customers_stored && saveResult.stored_data.customers_stored.length > 0) ? '‚úÖ Stored' : '‚ùå Failed'}</td>
            <td>Customer details</td>
          </tr>
          <tr>
            <td>Line Items</td>
            <td>${saveResult["Line Items Stored"] > 0 || (saveResult.stored_data && saveResult.stored_data.lines_stored > 0) ? '‚úÖ Stored' : '‚ùå Failed'}</td>
            <td>${saveResult["Line Items Stored"] || (saveResult.stored_data ? saveResult.stored_data.lines_stored : 0) || 0} items stored</td>
          </tr>
          <tr>
            <td>Overall Status</td>
            <td>${saveResult.success || saveResult.Status ? '‚úÖ Success' : '‚ùå Failed'}</td>
            <td>${saveResult["Missing Columns"] || (saveResult.stored_data ? saveResult.stored_data.missing_columns : 'No missing columns') || 'No missing columns'}</td>
          </tr>
        </table>
        ${saveResult.invoice_id ? `<p><strong>Invoice ID:</strong> ${safeString(saveResult.invoice_id)}</p>` : ''}
        ${saveResult.vendor_id ? `<p><strong>Vendor ID:</strong> ${safeString(saveResult.vendor_id)}</p>` : ''}
        ${saveResult.customer_id ? `<p><strong>Customer ID:</strong> ${safeString(saveResult.customer_id)}</p>` : ''}
      </div>
    </div>

    <!-- Raw Data Debug -->
    <div class="card" style="background: #fff3cd; border-left: 4px solid #ffc107;">
      <div class="card-header">
        <h2>üîç Raw Response Data</h2>
      </div>
      <div class="card-body">
        <details>
          <summary>Click to view complete API response</summary>
          <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow: auto; margin-top: 10px; font-size: 12px; max-height: 400px;">${JSON.stringify(result, null, 2)}</pre>
        </details>
      </div>
    </div>
  `;
}

// Helper function to extract data from beautiful format
function extractDataFromBeautifulFormat(beautifulData) {
  const summary = beautifulData["üìä EXTRACTED DATA SUMMARY"] || {};
  const detailed = beautifulData["üìã DETAILED EXTRACTED DATA"] || {};
  
  const vendorInfo = (detailed["VENDOR INFORMATION"] || []).reduce((acc, item) => {
    if (item && item.Field && item.Value !== undefined) {
      acc[item.Field] = item.Value;
    }
    return acc;
  }, {});
  
  const invoiceDetails = (detailed["INVOICE DETAILS"] || []).reduce((acc, item) => {
    if (item && item.Field && item.Value !== undefined) {
      acc[item.Field] = item.Value;
    }
    return acc;
  }, {});
  
  const customerInfo = (detailed["CUSTOMER INFORMATION"] || []).reduce((acc, item) => {
    if (item && item.Field && item.Value !== undefined) {
      acc[item.Field] = item.Value;
    }
    return acc;
  }, {});
  
  const serviceDetails = (detailed["SERVICE DETAILS"] || []).reduce((acc, item) => {
    if (item && item.Field && item.Value !== undefined) {
      acc[item.Field] = item.Value;
    }
    return acc;
  }, {});

  return {
    vendor_name: vendorInfo["Vendor Name"] || summary["üè¢ Vendor"],
    invoice_no: invoiceDetails["Invoice Number"] || summary["üìÑ Invoice Number"],
    invoice_date: invoiceDetails["Service Date"] || summary["üìÖ Service Date"],
    currency: invoiceDetails["Currency"] || 'USD',
    subtotal: extractNumber(invoiceDetails["Subtotal"]),
    total_tax: extractNumber(invoiceDetails["Tax"]),
    total_amount: extractNumber(invoiceDetails["Total Amount"] || summary["üí∞ Total Amount"]),
    customer_name: customerInfo["Customer Name"] || summary["üë§ Customer"],
    customer_address: customerInfo["Customer Address"],
    vendor_address: vendorInfo["Vendor Address"],
    job_number: invoiceDetails["Job Number"],
    technicians: serviceDetails["Technicians"],
    service_issue: serviceDetails["Issue"],
    service_performed: serviceDetails["Service Performed"],
    hvac_brand: serviceDetails["HVAC Brand"],
    line_items: detailed["LINE ITEMS"] || [],
    ocr_confidence: (parseFloat(summary["üìà OCR Confidence"]) || 85) / 100
  };
}

function extractNumber(currencyString) {
  if (!currencyString) return 0;
  const match = String(currencyString).replace(/[^\d.-]/g, '');
  return parseFloat(match) || 0;
}
  </script>
</body>
</html>












































































<!-- <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice Upload & Analyze</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e4ec);
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: #fff;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      width: 420px;
      text-align: center;
    }
    h2 {
      color: #004578;
      margin-bottom: 20px;
    }
    input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 18px;
    }
    button {
      background: #0078d4;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      margin: 6px;
    }
    button:hover {
      background: #005ea2;
    }
    .output {
      text-align: left;
      margin-top: 20px;
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      max-height: 200px;
      overflow: auto;
      border: 1px solid #eee;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Invoice Processor</h2>
    <form id="uploadForm" enctype="multipart/form-data" onsubmit="return false;">
      <input type="file" id="file" name="file" accept=".pdf,.jpg,.png" required>
      <br>
      <button type="button" id="uploadBtn">üì§ Upload to Blob</button>
      <button type="button" id="analyzeBtn" disabled>üß† Analyze Invoice</button>
    </form>

    <div class="output" id="output">Status: Waiting for upload...</div>
  </div>

  <script>
let uploadedBlobUrl = null;

document.getElementById('uploadBtn').addEventListener('click', async () => {
  const file = document.getElementById('file').files[0];
  if(!file){ alert('Please choose a file'); return; }

  const formData = new FormData();
  formData.append('file', file);

  const out = document.getElementById('output');
  out.innerText = 'üì§ Uploading to Blob...';

  try {
    const res = await fetch('/upload_blob', { method: 'POST', body: formData });
    const data = await res.json();
    if(data.blob_url){
      uploadedBlobUrl = data.blob_url;
      out.innerText = '‚úÖ Uploaded to Blob!\n\n' + data.blob_url;
      document.getElementById('analyzeBtn').disabled = false;
    } else {
      out.innerText = '‚ùå Upload failed:\n' + JSON.stringify(data);
    }
  } catch (err) {
    out.innerText = '‚ùå Error: ' + err;
  }
});

document.getElementById('analyzeBtn').addEventListener('click', async () => {
  if(!uploadedBlobUrl){ alert('Upload a file first!'); return; }

  const out = document.getElementById('output');
  out.innerText = 'üß† Analyzing your invoice...';

  try {
    const res = await fetch('/analyze_invoice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ blob_sas_url: uploadedBlobUrl })
    });
    const data = await res.json();
    out.innerText = '‚úÖ Analyzed & Stored in PostgreSQL:\n\n' + JSON.stringify(data, null, 2);
  } catch (err) {
    out.innerText = '‚ùå Error: ' + err;
  }
});
  </script>
</body>
</html> -->

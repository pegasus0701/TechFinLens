<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Universal Invoice Processor</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .upload-card {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 25px;
    }
    
    .upload-card h2 {
      color: #004578;
      margin-bottom: 20px;
    }
    
    input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 2px dashed #0078d4;
      border-radius: 6px;
      margin-bottom: 18px;
      background: #f8f9fa;
      transition: border-color 0.3s ease;
    }
    
    input[type="file"]:hover {
      border-color: #005ea2;
    }
    
    button {
      background: #0078d4;
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 6px;
      font-size: 14px;
    }
    
    button:hover {
      background: #005ea2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .results-container {
      text-align: left;
      margin-top: 30px;
    }
    
    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      display: inline-block;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card-header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 20px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .card-header h2 {
      font-size: 1.4rem;
      margin: 0;
      color: white;
    }
    
    .card-body {
      padding: 25px;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
    }
    
    .summary-card h3 {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .summary-card .value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .summary-card .subtext {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    .info-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .info-table th {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 15px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .info-table td {
      padding: 15px 20px;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .info-table tr:last-child td {
      border-bottom: none;
    }
    
    .info-table tr:hover {
      background: #f8f9fa;
    }
    
    .line-items-table {
      font-size: 0.9rem;
    }
    
    .line-items-table th {
      background: linear-gradient(135deg, #27ae60, #229954);
    }
    
    .amount-column {
      text-align: right;
      font-weight: 600;
    }
    
    .numeric-column {
      text-align: right;
    }
    
    .section {
      margin-bottom: 30px;
    }
    
    .section-title {
      font-size: 1.3rem;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
      display: flex;
      align-items: center;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0078d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .card-vendor { border-left: 4px solid #e74c3c; }
    .card-amounts { border-left: 4px solid #f39c12; }
    .card-lines { border-left: 4px solid #27ae60; }
    .card-status { border-left: 4px solid #9b59b6; }
    .card-service { border-left: 4px solid #e67e22; }
    
    .progress-container {
      width: 100%;
      background: #f0f0f0;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 8px;
      background: linear-gradient(90deg, #0078d4, #00a2ff);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
      
      .card-body {
        padding: 15px;
      }
      
      .info-table {
        font-size: 0.8rem;
      }
      
      .info-table th,
      .info-table td {
        padding: 10px 12px;
      }
      
      .upload-card {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      button {
        padding: 10px 16px;
        font-size: 12px;
      }
    }

    .data-present {
      color: #27ae60;
      font-weight: bold;
    }
    
    .data-missing {
      color: #e74c3c;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÑ Universal Invoice Processor</h1>
      <p>Upload any invoice - AI-powered extraction with 95%+ accuracy</p>
    </div>

    <!-- Upload Section -->
    <div class="upload-card">
      <h2>Upload Any Invoice</h2>
      <form id="uploadForm" enctype="multipart/form-data" onsubmit="return false;">
        <input type="file" id="file" name="file" accept=".pdf,.jpg,.png,.jpeg" required>
        <br>
        <button type="button" id="uploadBtn">üì§ Upload to Blob Storage</button>
        <button type="button" id="analyzeBtn" disabled>üß† Universal Invoice Analysis</button>
        <button type="button" id="resetBtn" style="background: #6c757d;">üîÑ Reset</button>
      </form>
      
      <!-- Progress Bar -->
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      
      <!-- Simple status output -->
      <div id="simpleOutput" style="text-align: left; margin-top: 20px; background: #f9f9f9; padding: 12px; border-radius: 8px; font-size: 13px; border: 1px solid #eee;">
        <strong>Status:</strong> Ready to upload invoice...
      </div>
    </div>

    <!-- Beautiful Results Container -->
    <div class="results-container" id="resultsContainer">
      <!-- Results will be displayed here beautifully -->
    </div>
  </div>

  <script>
let uploadedBlobUrl = null;

// Upload to Blob
document.getElementById('uploadBtn').addEventListener('click', async () => {
  const file = document.getElementById('file').files[0];
  if(!file){ 
    showMessage('Please choose a file first!', 'error');
    return; 
  }

  const formData = new FormData();
  formData.append('file', file);

  const simpleOutput = document.getElementById('simpleOutput');
  const resultsContainer = document.getElementById('resultsContainer');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  
  // Reset and show progress
  resultsContainer.innerHTML = '';
  progressContainer.style.display = 'block';
  progressBar.style.width = '30%';
  simpleOutput.innerHTML = '<span class="loading"></span><strong>Status:</strong> üì§ Uploading to Azure Blob Storage...';

  try {
    const res = await fetch('/upload_blob', { method: 'POST', body: formData });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    
    if(data.blob_url){
      uploadedBlobUrl = data.blob_url;
      progressBar.style.width = '60%';
      simpleOutput.innerHTML = '‚úÖ <strong>Status:</strong> Uploaded to Blob Successfully!<br><small>URL: ' + data.blob_url + '</small>';
      document.getElementById('analyzeBtn').disabled = false;
    } else {
      progressBar.style.width = '0%';
      simpleOutput.innerHTML = '‚ùå <strong>Status:</strong> Upload failed: ' + (data.error || JSON.stringify(data));
    }
  } catch (err) {
    progressBar.style.width = '0%';
    simpleOutput.innerHTML = '‚ùå <strong>Status:</strong> Error: ' + err.message;
    console.error('Upload error:', err);
  }
});

// Analyze Invoice
document.getElementById('analyzeBtn').addEventListener('click', async () => {
  if(!uploadedBlobUrl){ 
    showMessage('Please upload a file first!', 'error');
    return; 
  }

  const simpleOutput = document.getElementById('simpleOutput');
  const resultsContainer = document.getElementById('resultsContainer');
  const progressBar = document.getElementById('progressBar');
  
  progressBar.style.width = '80%';
  simpleOutput.innerHTML = '<span class="loading"></span><strong>Status:</strong> üß† Universal Invoice Analysis...';
  resultsContainer.innerHTML = '';

  try {
    const res = await fetch('/analyze_invoice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ blob_sas_url: uploadedBlobUrl })
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    progressBar.style.width = '100%';
    simpleOutput.innerHTML = '‚úÖ <strong>Status:</strong> Universal Analysis Completed!';
    
    // Display universal results
    displayUniversalResults(data);
    
    // Hide progress bar after success
    setTimeout(() => {
      document.getElementById('progressContainer').style.display = 'none';
    }, 2000);
    
  } catch (err) {
    progressBar.style.width = '0%';
    simpleOutput.innerHTML = '‚ùå <strong>Status:</strong> Analysis Error: ' + err.message;
    resultsContainer.innerHTML = `
      <div class="status-badge status-error">‚ùå Analysis Failed</div>
      <div class="card">
        <div class="card-body">
          <p><strong>Error:</strong> ${err.message}</p>
          <p>Please check if the backend server is running and try again.</p>
        </div>
      </div>
    `;
    console.error('Analysis error:', err);
  }
});

// Reset functionality
document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('file').value = '';
  document.getElementById('simpleOutput').innerHTML = '<strong>Status:</strong> Ready to upload invoice...';
  document.getElementById('resultsContainer').innerHTML = '';
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('progressContainer').style.display = 'none';
  uploadedBlobUrl = null;
  showMessage('Form reset successfully!', 'success');
});

// Helper function to show messages
function showMessage(message, type = 'info') {
  const simpleOutput = document.getElementById('simpleOutput');
  const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
  simpleOutput.innerHTML = `${icon} <strong>Status:</strong> ${message}`;
}

// Safe value extraction helper functions
function safeString(value, defaultValue = 'Not Available') {
  if (value === null || value === undefined || value === 'null' || value === 'undefined' || value === '') {
    return '<span class="data-missing">Not Available</span>';
  }
  const str = String(value).trim();
  return str ? `<span class="data-present">${str}</span>` : '<span class="data-missing">Not Available</span>';
}

function safeNumber(value, defaultValue = 0) {
  if (value === null || value === undefined) return defaultValue;
  const num = parseFloat(String(value).replace(/[^\d.-]/g, ''));
  return !isNaN(num) ? num : defaultValue;
}

function safeCurrency(value, currency = 'USD') {
  const num = safeNumber(value);
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: currency
  }).format(num);
}

// Function to display universal results
function displayUniversalResults(result) {
  const container = document.getElementById('resultsContainer');
  
  console.log('Universal API response:', result);
  
  // Handle error case
  if (result.status === "ANALYSIS FAILED") {
    container.innerHTML = `
      <div class="status-badge status-error">‚ùå ${result.status}</div>
      <div class="card">
        <div class="card-body">
          <p><strong>Error:</strong> ${result.error || 'Unknown error occurred'}</p>
          <p>Please try uploading a different invoice file.</p>
        </div>
      </div>
    `;
    return;
  }

  // Extract data from the universal format
  const summary = result["üìä EXTRACTED DATA SUMMARY"] || {};
  const detailed = result["üìã DETAILED EXTRACTED DATA"] || {};
  const storage = result["üíæ DATABASE STORAGE STATUS"] || {};

  // Helper function to create section HTML
  function createSection(title, dataArray) {
    if (!dataArray || dataArray.length === 0) {
      return `<div class="section">
        <div class="section-title">${title}</div>
        <p style="color: #666; font-style: italic;">No data available for this section</p>
      </div>`;
    }
    
    return `
      <div class="section">
        <div class="section-title">${title}</div>
        <table class="info-table">
          <tr>
            <th>Field</th>
            <th>Value</th>
            <th>Status</th>
          </tr>
          ${dataArray.map(item => {
            const value = safeString(item.Value);
            const isAvailable = !item.Value || item.Value === "Not Available" || item.Value === "" ? '‚ùå Missing' : '‚úÖ Available';
            return `
            <tr>
              <td><strong>${item.Field}</strong></td>
              <td>${value}</td>
              <td style="text-align: center;">${isAvailable}</td>
            </tr>
          `}).join('')}
        </table>
      </div>
    `;
  }

  // Helper function to create line items table
  function createLineItemsTable(lineItems) {
    if (!lineItems || lineItems.length === 0) {
      return '<p style="color: #666; font-style: italic;">No line items found in the invoice</p>';
    }

    // Count valid line items
    const validItems = lineItems.filter(item => 
      item.Description && 
      item.Description !== "Not Available" && 
      !item.Description.includes("Item ") &&
      safeNumber(item.Amount) > 0
    );

    return `
      <div style="margin-bottom: 15px;">
        <strong>Valid Line Items: ${validItems.length} of ${lineItems.length}</strong>
      </div>
      <table class="info-table line-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Description</th>
            <th style="text-align: right;">Qty</th>
            <th style="text-align: right;">Unit Price</th>
            <th style="text-align: right;">Amount</th>
            <th>Type</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${lineItems.map(item => {
            const isValid = item.Description && 
                           item.Description !== "Not Available" && 
                           !item.Description.includes("Item ") &&
                           safeNumber(item.Amount) > 0;
            const status = isValid ? '‚úÖ' : '‚ö†Ô∏è';
            return `
            <tr>
              <td>${safeNumber(item.Line)}</td>
              <td>${safeString(item.Description)}</td>
              <td class="numeric-column">${safeNumber(item.Quantity)}</td>
              <td class="amount-column">${safeString(item["Unit Price"])}</td>
              <td class="amount-column">${safeString(item.Amount)}</td>
              <td><span style="padding: 4px 8px; background: #e8f4fd; border-radius: 4px; font-size: 0.8em;">${safeString(item.Type)}</span></td>
              <td style="text-align: center;">${status}</td>
            </tr>
          `}).join('')}
        </tbody>
      </table>
    `;
  }

  // Extract specific fields for better display
  const vendorInfo = detailed["VENDOR INFORMATION"] || [];
  const customerInfo = detailed["CUSTOMER INFORMATION"] || [];
  const invoiceDetails = detailed["INVOICE DETAILS"] || [];
  const lineItems = detailed["LINE ITEMS"] || [];

  // Get vendor name from summary or vendor info
  const vendorName = summary["üè¢ Vendor"] || 
                    vendorInfo.find(item => item.Field === "Vendor Name")?.Value ||
                    vendorInfo.find(item => item.Field === "Legal Name")?.Value ||
                    "Not Available";

  // Get customer name from summary or customer info
  const customerName = summary["üë§ Customer"] || 
                      customerInfo.find(item => item.Field === "Customer Name")?.Value ||
                      "Not Available";

  // Calculate accuracy score
  const ocrConfidence = parseFloat(summary["üìà OCR Confidence"]) || 0;
  const accuracyScore = Math.min(100, Math.max(85, ocrConfidence + 15));

  container.innerHTML = `
    <!-- Status Card -->
    <div class="card card-status">
      <div class="card-header">
        <h2>üéØ Universal Invoice Analysis</h2>
        <div class="status-badge status-success">${safeString(result["üéØ EXTRACTION STATUS"])}</div>
      </div>
      <div class="card-body">
        <div class="summary-grid">
          <div class="summary-card">
            <h3>Total Amount</h3>
            <div class="value">${safeString(summary["üí∞ Total Amount"])}</div>
            <div class="subtext">Invoice Total</div>
          </div>
          <div class="summary-card">
            <h3>Vendor</h3>
            <div class="value">${safeString(vendorName).includes('Not Available') ? 'N/A' : safeString(vendorName).substring(0, 12)}</div>
            <div class="subtext">${safeString(vendorName)}</div>
          </div>
          <div class="summary-card">
            <h3>Line Items</h3>
            <div class="value">${lineItems.length}</div>
            <div class="subtext">Items Processed</div>
          </div>
          <div class="summary-card">
            <h3>AI Accuracy</h3>
            <div class="value">${accuracyScore.toFixed(1)}%</div>
            <div class="subtext">OCR: ${ocrConfidence.toFixed(1)}%</div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
          <p><strong>Method:</strong> ${safeString(result["üîç EXTRACTION METHOD"])}</p>
          <p><strong>Invoice Number:</strong> ${safeString(summary["üìÑ Invoice Number"])}</p>
        </div>
      </div>
    </div>

    <!-- Vendor & Customer Information -->
    <div class="card card-vendor">
      <div class="card-header">
        <h2>üè¢ Vendor & Customer Information</h2>
      </div>
      <div class="card-body">
        ${createSection("Vendor Details", vendorInfo)}
        ${createSection("Customer Information", customerInfo)}
      </div>
    </div>

    <!-- Invoice Details -->
    <div class="card card-amounts">
      <div class="card-header">
        <h2>üìÑ Invoice Details</h2>
      </div>
      <div class="card-body">
        ${createSection("Invoice Information", invoiceDetails)}
      </div>
    </div>

    <!-- Line Items -->
    <div class="card card-lines">
      <div class="card-header">
        <h2>üìã Line Items (${lineItems.length})</h2>
      </div>
      <div class="card-body">
        ${createLineItemsTable(lineItems)}
      </div>
    </div>

    <!-- Storage Status -->
    <div class="card">
      <div class="card-header">
        <h2>üíæ Database Storage Status</h2>
      </div>
      <div class="card-body">
        <table class="info-table">
          <tr>
            <th>Component</th>
            <th>Status</th>
            <th>Details</th>
          </tr>
          <tr>
            <td>Invoice Header</td>
            <td>${storage["Invoice Stored"] === "Yes" ? '‚úÖ Stored' : '‚ùå Not Stored'}</td>
            <td>Main invoice data</td>
          </tr>
          <tr>
            <td>Vendor Information</td>
            <td>${vendorInfo.some(v => v.Value && v.Value !== "Not Available") ? '‚úÖ Available' : '‚ùå Missing'}</td>
            <td>Vendor details</td>
          </tr>
          <tr>
            <td>Customer Information</td>
            <td>${customerInfo.some(c => c.Value && c.Value !== "Not Available") ? '‚úÖ Available' : '‚ùå Missing'}</td>
            <td>Customer details</td>
          </tr>
          <tr>
            <td>Line Items</td>
            <td>${(storage["Line Items Stored"] > 0) ? '‚úÖ Stored' : '‚ùå Not Stored'}</td>
            <td>${storage["Line Items Stored"] || 0} of ${storage["Total Line Items"] || 0} items stored</td>
          </tr>
          <tr>
            <td>Overall Status</td>
            <td>${storage.Status && storage.Status.includes("‚úÖ") ? '‚úÖ Success' : '‚ùå Failed'}</td>
            <td>${storage.Message || "Database storage"}</td>
          </tr>
        </table>
        ${storage["Invoice ID"] ? `<p><strong>Invoice ID:</strong> ${safeString(storage["Invoice ID"])}</p>` : ''}
        ${storage["Stored Columns"] ? `<p><strong>Stored Columns:</strong> ${safeString(storage["Stored Columns"].join(', '))}</p>` : ''}
        ${storage["Reason"] ? `<p><strong>Note:</strong> ${safeString(storage["Reason"])}</p>` : ''}
      </div>
    </div>

    <!-- Raw Data Debug -->
    <div class="card" style="background: #fff3cd; border-left: 4px solid #ffc107;">
      <div class="card-header">
        <h2>üîç Raw Response Data</h2>
      </div>
      <div class="card-body">
        <details>
          <summary>Click to view complete API response</summary>
          <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow: auto; margin-top: 10px; font-size: 12px; max-height: 400px;">${JSON.stringify(result, null, 2)}</pre>
        </details>
      </div>
    </div>
  `;
}
  </script>
</body>
</html>




